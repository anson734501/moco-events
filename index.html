<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MO.CO å®æ—¶äº‹ä»¶</title>
  <style>
    body { background: #1e1e1e; color: #fff; font-family: Arial, sans-serif; padding: 20px; }
    h1, h2 { color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 30px; }
    th, td { padding: 2px 6px; text-align: left; border-bottom: 1px solid #555; }
    th { background-color: #333; }
    tr:hover { background-color: #444; }
    .empty-row { text-align: center; color: #aaa; font-style: italic; padding: 20px; }
  </style>
</head>
<body>
  <h1>MO.CO å®æ—¶äº‹ä»¶</h1>
  <p id="timeNow" style="color: #bbb; margin-top: -10px; font-family: monospace;"></p>

  <h2>ğŸŸ¢ å½“å‰äº‹ä»¶</h2>
  <table>
    <thead>
      <tr>
        <th>å¼€å§‹æ—¶é—´</th>
        <th>åœ°å›¾åç§°</th>
        <th>äº‹ä»¶åç§°</th>
      </tr>
    </thead>
    <tbody id="currentEvents">
      <tr class="empty-row"><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr>
    </tbody>
  </table>

  <h2>ğŸŸ¡ å³å°†å¼€å§‹</h2>
  <table>
    <thead>
      <tr>
        <th>å¼€å§‹æ—¶é—´</th>
        <th>åœ°å›¾åç§°</th>
        <th>äº‹ä»¶åç§°</th>
      </tr>
    </thead>
    <tbody id="upcomingEvents">
      <tr class="empty-row"><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr>
    </tbody>
  </table>

  <script>
    // å…¨å±€ serverTime
    let serverTime = 0;

    function updateBeijingTime() {
      const now = new Date();
      const beijingOffset = 8 * 60;
      const localOffset = now.getTimezoneOffset();
      const beijingTime = new Date(now.getTime() + (beijingOffset + localOffset) * 60000);
      const yyyy = beijingTime.getFullYear();
      const mm = String(beijingTime.getMonth() + 1).padStart(2, '0');
      const dd = String(beijingTime.getDate()).padStart(2, '0');
      const hh = String(beijingTime.getHours()).padStart(2, '0');
      const min = String(beijingTime.getMinutes()).padStart(2, '0');
      const ss = String(beijingTime.getSeconds()).padStart(2, '0');
      document.getElementById("timeNow").textContent = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }
    updateBeijingTime();
    setInterval(updateBeijingTime, 1000);

    const eventNames = {
      "1": "é«˜èƒ½è­¦æŠ¥", "3": "å…¥ä¾µè­¦æŠ¥", "5": "åŒå€ç»éªŒå€¼", "374": "æ··æ²Œå–·å°„æ€ª",
      "112": "ç²¾çµç‹‚çƒ­(å¼ºå£®)", "207": "å…¥ä¾µè­¦æŠ¥", "432": "æ··æ²Œæ¸…é“å¤«", "435": "æ··æ²ŒèŠ±æœµ",
      "92": "ç²¾çµç‹‚çƒ­(èˆè€…)", "177": "æ¸…é“å¤«é›†ç¾¤", "188": "é‡å¯é­”å®", "194": "é‡å¯é‡‡é›†å™¨",
      "195": "æ‹¯æ•‘æˆ˜æœ¯çŒ«", "197": "é‡å¤§ç ”ç©¶", "198": "å¥½å¤šå—…æ¢å™¨", "199": "å·¥ç¨‹å¸ˆæ±‚åŠ©",
      "201": "å…¥ä¾µè­¦æŠ¥", "202": "å…¥ä¾µè­¦æŠ¥", "203": "å…¥ä¾µè­¦æŠ¥", "204": "å…¥ä¾µè­¦æŠ¥",
      "206": "å…¥ä¾µè­¦æŠ¥", "370": "æ··æ²Œå†²å‡»æ€ª", "372": "æ··æ²Œæ‚è€æ€ª", "373": "æ··æ²Œéª‘å£«",
      "433": "æ··æ²Œç‹—ç‹—æ€ª", "434": "æ··æ²Œç¢éª¨æ€ª", "437": "æ··æ²Œç‹‚æ€’å…½", "438": "æ··æ²Œå¹å¹æ€ª",
      "439": "æ··æ²Œå†²é”‹æ€ª", "440": "æ··æ²Œé•¿çŸ›è·³è·³é¾™", "371": "æ··æ²ŒèŠ±æœµ", "205": "å…¥ä¾µè­¦æŠ¥",
      "431": "æ··æ²Œä¿é™©åº“", "375": "æ··æ²Œè·³æ–§æ€ª", "376": "æ··æ²Œé›•åƒ", "369": "æ··æ²Œè·³è·³é¾™"
    };

    const locations = {
      "5": "ç¥æ®¿æ‘", "6": "é’ç¿ åºŸå¢Ÿ", "7": "å­½ç”Ÿæ£®æ—",
      "26": "ç²¾çµæ´ç©´", "27": "åŸå ¡å¢™å£", "28": "å¬å”¤å¹¿åœº", "29": "ä¸‹æ°´é“",
      "30": "è…åŒ–æ‘åº„", "31": "è…åŒ–åºŸå¢Ÿ", "32": "è…åŒ–æ£®æ—",
      "33": "è…åŒ–æ´ç©´", "34": "è…åŒ–åŸå ¡", "35": "è…åŒ–ç¥æ®¿"
    };

    function roundToNearest5Min(date) {
      const ms = 1000 * 60 * 5;
      const rounded = new Date(Math.round(date.getTime() / ms) * ms);
      return {
        label: rounded.toLocaleTimeString('zh-CN', { hour12: false }),
        timestamp: rounded.getTime()
      };
    }

    async function fetchEvents() {
      try {
        const res = await Promise.race([
          fetch('https://sqbwiki.com:9330/'),
          new Promise((_, reject) => setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 5000))
        ]);
        const data = await res.json();
        if (!Array.isArray(data) || data.length < 2) throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');

        serverTime = data[0];
        const events = data.slice(1);
        const now = serverTime;

        const currentList = [];
        const upcomingList = [];

        events.forEach(event => {
          const start = serverTime + event.startTime * 1000;
          const end = serverTime + event.endTime * 1000;
          if (now >= start && now <= end && start !== end) {
            currentList.push(event);
          } else if (start > now) {
            upcomingList.push(event);
          }
        });

        const upcomingLoaded = render(upcomingList, document.getElementById("upcomingEvents"), 'æ•°æ®è·å–ä¸­â€¦â€¦', false, true);
        const currentEmptyText = upcomingLoaded && currentList.length === 0 ? 'æš‚æ— è¿›è¡Œä¸­çš„äº‹ä»¶' : 'æ•°æ®è·å–ä¸­â€¦â€¦';
        render(currentList, document.getElementById("currentEvents"), currentEmptyText, true);

      } catch (err) {
        console.error("è·å–äº‹ä»¶å¤±è´¥ï¼š", err);
        document.getElementById("currentEvents").innerHTML = `<tr class='empty-row'><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr>`;
        document.getElementById("upcomingEvents").innerHTML = `<tr class='empty-row'><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr>`;
      }
    }

    function render(list, container, emptyText, isCurrent = false, returnLoaded = false) {
      container.innerHTML = '';
      if (list.length === 0) {
        container.innerHTML = `<tr class='empty-row'><td colspan="3">${emptyText}</td></tr>`;
        return returnLoaded ? false : undefined;
      }

      const grouped = [];

      list.forEach(event => {
        const rawTime = isCurrent
          ? new Date(serverTime + event.endTime * 1000 - 5 * 60 * 1000)
          : new Date(serverTime + event.startTime * 1000);
        const rounded = roundToNearest5Min(rawTime);
        let group = grouped.find(g => g.timestamp === rounded.timestamp);
        if (!group) {
          group = { timestamp: rounded.timestamp, label: rounded.label, events: [] };
          grouped.push(group);
        }
        group.events.push(event);
      });

      grouped.sort((a, b) => a.timestamp - b.timestamp);

      grouped.forEach(group => {
        group.events.forEach((event, idx) => {
          const locId = event.location.split("-")[1] - 900000;
          const mapName = locations[locId] || `æœªçŸ¥åœ°å›¾(${event.location})`;
          const monsterId = event.unkArray[1] ? event.unkArray[1] - 800000 : null;
          let eventName = "æœªçŸ¥äº‹ä»¶";
          if (monsterId !== null) {
            eventName = eventNames[monsterId] || `æœªçŸ¥äº‹ä»¶ (${monsterId})`;
          } else if (event.type && eventNames[event.type]) {
            eventName = eventNames[event.type];
          }

          const tr = document.createElement("tr");
          const isRed = eventName.includes('é«˜èƒ½è­¦æŠ¥') || eventName.includes('æ··æ²Œ');
          const nameCell = isRed ? `<td><span style='color:red;font-weight:bold;'>${eventName}</span></td>` : `<td>${eventName}</td>`;
          const timeCell = idx === 0 ? `<td>${group.label}</td>` : `<td></td>`;
          tr.innerHTML = `${timeCell}<td>${mapName}</td>${nameCell}`;
          container.appendChild(tr);
        });

        const spacer = document.createElement("tr");
        spacer.innerHTML = `<td colspan="3" style="height:10px;"></td>`;
        container.appendChild(spacer);
      });

      return returnLoaded ? true : undefined;
    }

    fetchEvents();
    setInterval(fetchEvents, 5000);
  </script>
</body>
</html>