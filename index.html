<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MO.CO å®æ—¶äº‹ä»¶</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { background: #1e1e1e; color: #fff; font-family: Arial, sans-serif; padding: 20px; font-size: 17px; line-height: 1.2; }
    h1, h2 { color: #fff; font-size: 28px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 30px; table-layout: fixed; }
    th { background-color: #333; border-bottom: 1px solid #555; padding: 3px 6px; font-size: 16px; }
    td { padding: 3px 6px; font-size: 16px; border-bottom: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    th:nth-child(1), td:nth-child(1) { width: 80px; text-align: right; font-family: monospace; }
    th:nth-child(2), td:nth-child(2) { width: 120px; text-align: left; padding-left: 8px; padding-right: 8px; }
    th:nth-child(3), td:nth-child(3) { text-align: left; }
    tr:hover { background-color: #444; }
    .empty-row td { text-align: left !important; padding-left: 10px !important; color: #aaa; font-style: italic; padding-top: 2px; padding-bottom: 2px; } /* ç¼©å°çš„ä¸Šä¸‹é—´è· */
    #sourceIndicator { position: absolute; top: 8px; right: 10px; font-size: 12px; font-family: monospace; }
  </style>
</head>
<body>
  <div id="sourceIndicator">?</div>
  <h1>MO.CO å®æ—¶äº‹ä»¶</h1>
  <p id="timeNow" style="color: #bbb; margin-top: -10px; font-family: monospace;"></p>

  <h2>ğŸŸ¢ å½“å‰äº‹ä»¶</h2>
  <table>
    <thead><tr><th>å¼€å§‹æ—¶é—´</th><th>åœ°å›¾åç§°</th><th>äº‹ä»¶åç§°</th></tr></thead>
    <tbody id="currentEvents"><tr class="empty-row"><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr></tbody>
  </table>

  <h2>ğŸŸ¡ å³å°†å¼€å§‹</h2>
  <table>
    <thead><tr><th>å¼€å§‹æ—¶é—´</th><th>åœ°å›¾åç§°</th><th>äº‹ä»¶åç§°</th></tr></thead>
    <tbody id="upcomingEvents"><tr class="empty-row"><td colspan="3">æ•°æ®è·å–ä¸­â€¦â€¦</td></tr></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCTGMl8W8Jd5HuG8RsyWJrNd-KEVjfc-KA",
      authDomain: "my-realtime-database-cc6b7.firebaseapp.com",
      databaseURL: "https://my-realtime-database-cc6b7-default-rtdb.firebaseio.com",
      projectId: "my-realtime-database-cc6b7",
      storageBucket: "my-realtime-database-cc6b7.appspot.com",
      messagingSenderId: "825797371760",
      appId: "1:825797371760:web:7f8d17b9681e51168ed1b5"
    };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref("mocoCache");

    let serverTime = 0;

    const eventNames = {
      "1": "é«˜èƒ½è­¦æŠ¥", "3": "å…¥ä¾µè­¦æŠ¥", "5": "åŒå€ç»éªŒå€¼", "374": "æ··æ²Œå–·å°„æ€ª",
      "112": "ç²¾çµç‹‚çƒ­(å¼ºå£®)", "207": "å…¥ä¾µè­¦æŠ¥", "432": "æ··æ²Œæ¸…é“å¤«", "435": "æ··æ²ŒèŠ±æœµ",
      "92": "ç²¾çµç‹‚çƒ­(èˆè€…)", "177": "æ¸…é“å¤«é›†ç¾¤", "188": "é‡å¯é­”å®", "194": "é‡å¯é‡‡é›†å™¨",
      "195": "æ‹¯æ•‘æˆ˜æœ¯çŒ«", "197": "é‡å¤§ç ”ç©¶", "198": "å¥½å¤šå—…æ¢å™¨", "199": "å·¥ç¨‹å¸ˆæ±‚åŠ©",
      "201": "å…¥ä¾µè­¦æŠ¥", "202": "å…¥ä¾µè­¦æŠ¥", "203": "å…¥ä¾µè­¦æŠ¥", "204": "å…¥ä¾µè­¦æŠ¥",
      "206": "å…¥ä¾µè­¦æŠ¥", "370": "æ··æ²Œå†²å‡»æ€ª", "372": "æ··æ²Œæ‚è€æ€ª", "373": "æ··æ²Œéª‘å£«",
      "433": "æ··æ²Œç‹—ç‹—æ€ª", "434": "æ··æ²Œç¢éª¨æ€ª", "437": "æ··æ²Œç‹‚æ€’å…½", "438": "æ··æ²Œå¹å¹æ€ª",
      "439": "æ··æ²Œå†²é”‹æ€ª", "440": "æ··æ²Œé•¿çŸ›è·³è·³é¾™", "371": "æ··æ²ŒèŠ±æœµ", "205": "å…¥ä¾µè­¦æŠ¥",
      "431": "æ··æ²Œä¿é™©åº“", "375": "æ··æ²Œè·³æ–§æ€ª", "376": "æ··æ²Œé›•åƒ", "369": "æ··æ²Œè·³è·³é¾™"
    };

    const locations = {
      "5": "ç¥æ®¿æ‘", "6": "é’ç¿ åºŸå¢Ÿ", "7": "å­½ç”Ÿæ£®æ—",
      "26": "ç²¾çµæ´ç©´", "27": "åŸå ¡å¢™å£", "28": "å¬å”¤å¹¿åœº", "29": "ä¸‹æ°´é“",
      "30": "è…åŒ–æ‘åº„", "31": "è…åŒ–åºŸå¢Ÿ", "32": "è…åŒ–æ£®æ—",
      "33": "è…åŒ–æ´ç©´", "34": "è…åŒ–åŸå ¡", "35": "è…åŒ–ç¥æ®¿"
    };

    function updateBeijingTime() {
      const now = new Date();
      const beijingOffset = 8 * 60;
      const localOffset = now.getTimezoneOffset();
      const beijingTime = new Date(now.getTime() + (beijingOffset + localOffset) * 60000);
      const yyyy = beijingTime.getFullYear();
      const mm = String(beijingTime.getMonth() + 1).padStart(2, '0');
      const dd = String(beijingTime.getDate()).padStart(2, '0');
      const hh = String(beijingTime.getHours()).padStart(2, '0');
      const min = String(beijingTime.getMinutes()).padStart(2, '0');
      const ss = String(beijingTime.getSeconds()).padStart(2, '0');
      document.getElementById("timeNow").textContent = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }
    updateBeijingTime();
    setInterval(updateBeijingTime, 1000);

    function roundToNearest5Min(date) {
      const ms = 1000 * 60 * 5;
      const rounded = new Date(Math.round(date.getTime() / ms) * ms);
      return {
        label: rounded.toLocaleTimeString('zh-CN', { hour12: false }),
        timestamp: rounded.getTime()
      };
    }

    function render(list, container, emptyText, isCurrent = false, returnLoaded = false) {
      container.innerHTML = '';
      if (list.length === 0) {
        container.innerHTML = `<tr class="empty-row"><td colspan="3">${emptyText}</td></tr>`;
        return returnLoaded ? false : undefined;
      }

      const grouped = [];

      list.forEach(event => {
        const rawTime = isCurrent
          ? new Date(serverTime + event.endTime * 1000 - 5 * 60 * 1000)
          : new Date(serverTime + event.startTime * 1000);
        const rounded = roundToNearest5Min(rawTime);
        let group = grouped.find(g => g.timestamp === rounded.timestamp);
        if (!group) {
          group = { timestamp: rounded.timestamp, label: rounded.label, events: [] };
          grouped.push(group);
        }
        group.events.push(event);
      });

      grouped.sort((a, b) => a.timestamp - b.timestamp);

      grouped.forEach(group => {
        group.events.forEach((event, idx) => {
          const locId = event.location.split("-")[1] - 900000;
          const mapName = locations[locId] || `æœªçŸ¥åœ°å›¾(${event.location})`;
          const monsterId = event.unkArray[1] ? event.unkArray[1] - 800000 : null;
          let eventName = "æœªçŸ¥äº‹ä»¶";
          if (monsterId !== null) {
            eventName = eventNames[monsterId] || `æœªçŸ¥äº‹ä»¶ (${monsterId})`;
          } else if (event.type && eventNames[event.type]) {
            eventName = eventNames[event.type];
          }

          const tr = document.createElement("tr");
          const isRed = eventName.includes('é«˜èƒ½è­¦æŠ¥') || eventName.includes('æ··æ²Œ');
          const nameCell = isRed ? `<td><span style='color:red;font-weight:bold;'>${eventName}</span></td>` : `<td>${eventName}</td>`;
          const timeCell = idx === 0 ? `<td>${group.label}</td>` : `<td></td>`;
          tr.innerHTML = `${timeCell}<td>${mapName}</td>${nameCell}`;
          container.appendChild(tr);
        });

        const divider = document.createElement("tr");
        divider.innerHTML = `<td colspan="3" style="border-bottom: 2px dashed #888;"></td>`;
        container.appendChild(divider);
      });

      return returnLoaded ? true : undefined;
    }

    function renderFromData(dataSource, serverTimeValue, events) {
      const indicator = document.getElementById("sourceIndicator");
      if (dataSource === "æ¥å£") {
        indicator.textContent = "0";
        indicator.style.color = "limegreen";
      } else {
        indicator.textContent = "1";
        indicator.style.color = "hotpink";
      }

      serverTime = serverTimeValue;
      const now = Date.now(); // å…³é”®ï¼šç”¨å®¢æˆ·ç«¯å½“å‰æ—¶é—´åˆ¤æ–­äº‹ä»¶æ˜¯å¦ç»“æŸ

      const currentList = [];
      const upcomingList = [];

      events.forEach(event => {
        const start = serverTime + event.startTime * 1000;
        const end = serverTime + event.endTime * 1000;
        if (now >= start && now < end && start !== end) {
          currentList.push(event);
        } else if (start > now) {
          upcomingList.push(event);
        }
      });

      const upcomingLoaded = render(upcomingList, document.getElementById("upcomingEvents"), 'æ•°æ®è·å–ä¸­â€¦â€¦', false, true);
      const currentEmptyText = upcomingLoaded && currentList.length === 0 ? 'æš‚æ— è¿›è¡Œä¸­çš„äº‹ä»¶' : 'æ•°æ®è·å–ä¸­â€¦â€¦';
      render(currentList, document.getElementById("currentEvents"), currentEmptyText, true);
    }

    async function fetchEvents() {
      try {
        const res = await Promise.race([
          fetch('https://115.238.252.171:11485/proxy'),
          new Promise((_, reject) => setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 5000))
        ]);
        const data = await res.json();
        if (!Array.isArray(data) || data.length < 2) throw new Error("æ ¼å¼é”™è¯¯");

        const serverTime = data[0];
        const events = data.slice(1);

        await dbRef.set({ serverTime, events });
        renderFromData("æ¥å£", serverTime, events);
      } catch (e) {
        dbRef.once("value").then(snapshot => {
          const cached = snapshot.val();
          if (cached) {
            renderFromData("Firebase", cached.serverTime, cached.events || []);
          } else {
            document.getElementById("sourceIndicator").textContent = "?";
            document.getElementById("sourceIndicator").style.color = "#888";
          }
        });
      }
    }

    fetchEvents();
    setInterval(fetchEvents, 5000);
  </script>
</body>
</html>
